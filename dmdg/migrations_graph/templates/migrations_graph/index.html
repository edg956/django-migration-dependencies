<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <title>Django Migration Dependencies Graph</title>
    </head>
    <body>
        <div id="container" style="height: 100vh; width: 100vw"></div>
        <script src="https://cdn.jsdelivr.net/npm/cytoscape@3.23.0/dist/cytoscape.min.js"></script>
        <script type="text/javascript">
            function randomColorGenerator(nColors) {
                const colors = []
                while (colors.length < nColors) {
                    let color = Math.floor(Math.random() * (Math.pow(2, 24) - 1)).toString(16);
                    if (color.length !== 6) {
                        color = "0".repeat(6-color.length) + color
                    }
                    color = "#"+color
                    if (colors.includes(color)) continue;
                    colors.push(color);
                }
                return colors
            }

            let nodes = [
            {% for node in nodes %}
                {
                    id: "{{node.id}}",
                    name: "{{node.name}}",
                    {% if node.parent %} parent: "{{node.parent}}", {% endif %}
                    type: "{{node.type}}"
                },
            {% endfor %}
            ]
            let edges = [
            {% for edge in edges %}
                {
                    id: "{{edge.id}}",
                    source: "{{edge.source}}",
                    target: "{{edge.target}}",
                },
            {% endfor %}]

            let apps = nodes.filter(n => !n.parent)
            let colorsByApp = {}
            randomColorGenerator(apps.length).forEach((color, idx) => {
                colorsByApp[apps[idx].name] = color;
            })

            nodes = nodes.map(n => {
                let app = n.type === 'app' ? n.name : n.parent
                n.color = colorsByApp[app]
                n.app = app
                return n
            })

            edges.forEach(n => {
                let sourceApp = n.source.split('-')[0];
                let targetApp = n.target.split('-')[0];
                if (sourceApp !== targetApp) {
                    n.color = colorsByApp[sourceApp]
                } else {
                    n.color = "gray"
                }
                n.sourceApp = sourceApp
                n.targetApp = targetApp
            })

            const cy = cytoscape({
                container: document.getElementById('container'),
                elements: {
                    nodes: nodes.map(n => { return {data: n}}),
                    edges: edges.map(n => { return {data: n}})
                },
                layout: {name: "breadthfirst", directed: true, padding: 10},
                style: [
                    {selector: 'node', style: {label: 'data(name)', 'background-color': 'data(color)'}},
                    {selector: 'edge', style: {'line-color': 'data(color)'}}
                ]
            })
        </script>
    </body>
</html>